# WaveformAnalysis：Doc Anchor + CI 文档同步检查规范（方案文档）

> 目的：在代码里标注“对应文档位置”，并通过 CI 强制提醒/检查，避免“改了代码忘了改文档”。

---

## 1. 背景与目标

WaveformAnalysis 的插件与架构在持续演进（插件契约、配置推断、缓存/血缘、时间字段、存储布局等）。当这些关键逻辑发生变化时，相关文档也必须同步更新，否则会出现：

- 用户按文档使用但行为与实际不一致
- 缓存/配置/单位变化导致排查困难
- 新贡献者不了解改动影响面，维护成本上升

**目标**：
1) 在代码里用统一格式标明“对应文档的位置”；
2) CI 检查这些标注是否有效，并在 PR 中提醒/强制“改代码也要改对应文档”。

---

## 2. 术语定义

- **Doc Anchor**：代码中的注释标记，用来指向某份文档（文件路径 + 可选锚点）。
- **锚点（Anchor）**：文档内的章节定位（通常对应 Markdown 标题的 slug）。

---

## 3. Doc Anchor 注释规范

### 3.1 注释格式（统一约定）
在代码中使用以下格式标注文档引用：

- 基本形式：
`# DOC: docs/<path>.md`

- 带锚点形式：
`# DOC: docs/<path>.md#<anchor>`

### 3.2 书写要求
- `docs/` 必须是相对仓库根目录的路径（避免本地路径差异）。
- 一条 `# DOC:` 只指向一个文档位置，保持清晰可检索。
- 注释内容尽量只包含“文档定位”，不要复制大段文档文字（避免双处维护）。

### 3.3 推荐放置位置（优先级）
建议优先在以下位置增加 `# DOC:`：

1) **插件契约/接口处**：`provides / depends_on / version / output_schema / config_spec` 周边
2) **配置解析与推断处**：ConfigResolver、适配器推断采样率/单位、默认值规则
3) **存储与缓存/血缘处**：缓存 key 组成、lineage 计算、存储布局（work_dir/run_id 等）
4) **兼容/弃用处**：compat 垫片、alias 映射、Deprecated 行为说明
5) **CLI 行为处**：参数默认值、profile 选择、输出文件默认路径等

---

## 4. CI 检查策略（两级：基础校验 + 文档同步）

CI 分两类检查，建议先从温和规则开始，逐步收紧。

### 4.1 基础校验（Doc Anchor 合法性）
**检查内容：**
- 代码中出现的 `# DOC:` 指向的 `docs/*.md` 文件必须存在
                                      - （可选）若带 `#anchor`，则尽力校验该 anchor 在文档中存在

                                     **结果策略：**
                                     - 文档文件不存在：**失败（Fail）**
                                     - 锚点不存在：建议先 **警告（Warn）**，等锚点规范稳定后再升级为失败

### 4.2 文档同步检查（PR 规则）
                                     **触发条件（建议）：**
                                     当 PR 修改了以下关键目录中的代码时，需要触发文档同步检查：
                                     - `waveform_analysis/core/`
                                     - `waveform_analysis/core/plugins/`
                                     - `waveform_analysis/utils/formats/`

                                     **检查逻辑：**
                                     - 对 PR 中变更的代码文件，扫描其中出现的 `# DOC:` 引用
                                     - 若引用的文档文件没有在本 PR 中发生变更，则判定为“可能遗漏文档更新”

                                     **结果策略（建议阶段性推进）：**
                                     - 初期：**仅提示（Warn）**，在 CI 输出“建议更新的 docs 列表”
                                     - 中期：对核心路径（如 plugins/contracts、config、storage、time field）升级为 **失败（Fail）**
                                     - 成熟期：对全部触发条件升级为 **失败（Fail）**

                                     ---

## 5. 推荐的 PR Checklist（写进 CONTRIBUTING / PR 模板）

当 PR 涉及以下任一项时，必须同步更新文档（并通过 CI）：

- 新增/修改/移除插件输出字段（dtype/单位/命名）
- 修改配置项（默认值、优先级、推断规则）
- 修改 pipeline 依赖关系（depends_on/provides）
- 修改缓存 key / lineage 生成逻辑
- 修改存储布局、目录结构、文件命名、run_id/work_dir 语义
- 修改 streaming 的 time_field、chunk 对齐、并行策略默认行为
- 新增/修改 profile（cpu_default/streaming_default 等）或 standard plugin 的推荐入口

---

## 6. 锚点（Anchor）规范建议

为降低“锚点经常失效”的概率：

- 文档标题尽量稳定，不频繁改动
- 标题层级尽量清晰，避免多个章节同名
- 推荐在文档中加入稳定的小标题作为锚点（例如 `## ConfigResolver` 这种）

                                     **CI 对锚点校验**建议采用“best-effort”策略：
                                     - 先校验文件存在（硬要求）
                                     - 锚点先警告，逐步加强

                                     ---

## 7. 分阶段落地路线图

### Phase 1（最小可用）
- 约定 `# DOC:` 格式
- CI 校验：文档文件存在（Fail）
- CI 校验：锚点存在（Warn）
- 文档同步检查（Warn）

### Phase 2（收紧）
- 将关键路径（plugins/contracts、config、storage、time field）的文档同步检查升级为 Fail
- PR 模板加入“文档同步”检查项

### Phase 3（成熟）
- 所有触发路径的文档同步检查 Fail
- 锚点校验从 Warn 升级为 Fail（前提：锚点规范稳定）

---

## 8. 维护原则（避免新的技术债）

- `# DOC:` 只做定位，不复制内容
- compat/弃用逻辑必须有明确文档指向
- 新增关键模块/插件时，必须同步添加 `# DOC:` 与对应 docs 页面
- 当文档结构调整时，必须同步更新代码中的 `# DOC:` 引用（CI 会帮你发现漏改）

---

## 9. 预期收益

- 改代码时可立刻定位要同步更新的文档位置
- PR 阶段就能发现“代码改了但文档没改”
- 文档与实现的一致性更强，降低维护与 onboarding 成本
- 为后续“插件契约化 / profiles 体系 / 自动文档生成”打下基础（Doc Anchor 可作为输入）

---

