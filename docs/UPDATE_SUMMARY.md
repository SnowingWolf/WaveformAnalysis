# é¡¹ç›®æ›´æ–°æ€»ç»“ï¼šå†…å­˜ä¼˜åŒ–åŠŸèƒ½

## æ¦‚è¿°

å·²æˆåŠŸå®ç°æ³¢å½¢æ•°æ®åŠ è½½çš„å¯é€‰åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·åœ¨ä¸éœ€è¦åŸå§‹æ³¢å½¢æ—¶è·³è¿‡åŠ è½½ï¼ŒèŠ‚çœ 70-80% çš„å†…å­˜ä½¿ç”¨ã€‚

**å…³é”®ç‰¹æ€§**:
- âœ… æ·»åŠ  `load_waveforms` å‚æ•°
- âœ… å®Œå…¨åå‘å…¼å®¹ï¼ˆé»˜è®¤ `True`ï¼‰
- âœ… è·³è¿‡ä¸éœ€è¦çš„ CSV è¯»å–å’Œæ•°æ®è½¬æ¢
- âœ… ä¿ç•™æ‰€æœ‰ç»Ÿè®¡ç‰¹å¾ï¼ˆå³°å€¼ã€ç”µè·ã€æ—¶é—´æˆ³ï¼‰
- âœ… ä¼˜é›…å¤„ç†è¾¹ç•Œæƒ…å†µ

---

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. **æ ¸å¿ƒæ¨¡å—ä¿®æ”¹**

#### `waveform_analysis/core/dataset.py` â­ ä¸»è¦ä¿®æ”¹
- **ç¬¬ 27 è¡Œ**: æ·»åŠ  `load_waveforms: bool = True` å‚æ•°åˆ° `__init__()`
  - é»˜è®¤ `True` ç»´æŒåå‘å…¼å®¹æ€§
  - æ–°å¢è¯¦ç»†çš„å‚æ•°æ–‡æ¡£è¯´æ˜

- **ç¬¬ 40 è¡Œ**: å­˜å‚¨å‚æ•°ä¸ºå®ä¾‹å˜é‡
  ```python
  self.load_waveforms = load_waveforms
  ```

- **ç¬¬ 176-198 è¡Œ**: ä¿®æ”¹ `extract_waveforms()` æ–¹æ³•
  - æ£€æŸ¥ `if not self.load_waveforms`
  - è·³è¿‡ CSV è¯»å–ï¼Œç›´æ¥è¿”å›
  - æ‰“å°: `"è·³è¿‡æ³¢å½¢æå–ï¼ˆload_waveforms=Falseï¼‰"`

- **ç¬¬ 200-230 è¡Œ**: ä¿®æ”¹ `structure_waveforms()` æ–¹æ³•
  - æ£€æŸ¥ `if not self.load_waveforms`
  - è·³è¿‡æ•°æ®ç»“æ„åŒ–ï¼Œç›´æ¥è¿”å›
  - æ‰“å°: `"è·³è¿‡æ³¢å½¢ç»“æ„åŒ–ï¼ˆload_waveforms=Falseï¼‰"`

- **ç¬¬ 426-458 è¡Œ**: ä¿®æ”¹ `get_waveform_at()` æ–¹æ³•
  - æ£€æŸ¥æ³¢å½¢æ˜¯å¦å·²åŠ è½½
  - å¦‚æœªåŠ è½½ï¼Œè¿”å› `None`
  - æ‰“å°è­¦å‘Š: `"âš ï¸  æ³¢å½¢æ•°æ®æœªåŠ è½½ï¼ˆload_waveforms=Falseï¼‰"`

---

## æ–°å¢æ–‡ä»¶

### 2. **æ–‡æ¡£æ–‡ä»¶**

#### `docs/MEMORY_OPTIMIZATION.md` ğŸ“– å®Œæ•´æŒ‡å—
- è¯¦ç»†è¯´æ˜å†…å­˜ä¼˜åŒ–åŠŸèƒ½
- å·¥ä½œåŸç†å’Œå®ç°ç»†èŠ‚
- å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œå¯¹æ¯”
- æ€§èƒ½æ•°æ®å’Œé¢„æœŸèŠ‚çœ
- å¸¸è§é—®é¢˜è§£ç­”

#### `HOW_TO_SKIP_WAVEFORMS.md` ğŸ¯ å¿«é€Ÿå‚è€ƒ
- ç®€çŸ­ç­”æ¡ˆå’Œè¯¦ç»†è§£ç­”
- å®é™…ä½¿ç”¨ç¤ºä¾‹
- ä½•æ—¶ä½¿ç”¨çš„å»ºè®®
- å¸¸è§é—®é¢˜
- æŠ€æœ¯ç»†èŠ‚

### 3. **ç¤ºä¾‹ä»£ç **

#### `examples/skip_waveforms.py` ğŸ’» å®Œæ•´ç¤ºä¾‹
- `example_without_waveforms()` - åŸºæœ¬ç”¨æ³•æ¼”ç¤º
- `example_with_and_without_comparison()` - æ€§èƒ½å¯¹æ¯”
- `example_memory_usage()` - å†…å­˜ä¼°è®¡
- è¯¦ç»†çš„è¾“å‡ºå’Œè¯´æ˜

#### `scripts/demo_skip_waveforms.py` ğŸ“Š äº¤äº’å¼æ¼”ç¤º
- æ¸…æ™°çš„ä½¿ç”¨å»ºè®®
- å·¥ä½œæµå¯¹æ¯”è¡¨æ ¼
- å®é™…ä»£ç ç¤ºä¾‹
- è®¿é—®æ•°æ®çš„å¯¹æ¯”

### 4. **æµ‹è¯•æ–‡ä»¶**

#### `tests/test_skip_waveforms.py` ğŸ§ª åŠŸèƒ½æµ‹è¯•
- `test_without_waveforms()` - éªŒè¯è·³è¿‡æ³¢å½¢æ—¶çš„è¡Œä¸º
- `test_with_waveforms()` - éªŒè¯æ­£å¸¸åŠ è½½çš„è¡Œä¸º
- è¯¦ç»†çš„æµ‹è¯•è¾“å‡ºå’ŒéªŒè¯

---

## æ›´æ–°çš„æ–‡æ¡£

### 5. **å·²ä¿®æ”¹çš„æ–‡æ¡£**

#### `docs/USAGE.md`
**æ·»åŠ **:
- "å†…å­˜ä¼˜åŒ–" ç« èŠ‚ï¼ˆæ–°å¢ï¼‰
  - `load_waveforms=False` ç”¨æ³•ç¤ºä¾‹
  - æƒè¡¡è¯´æ˜ï¼ˆä¼˜ç‚¹/ç¼ºç‚¹ï¼‰
  - å®Œæ•´çš„ä»£ç ç¤ºä¾‹
  - é“¾æ¥åˆ°å®Œæ•´æŒ‡å—

- æ›´æ–°"å¸¸è§é—®é¢˜"éƒ¨åˆ†
  - æ·»åŠ "å¦‚ä½•å¤„ç†å¤§æ•°æ®é›†?"
  - æ¨èä½¿ç”¨ `load_waveforms=False`

#### `QUICKSTART.md` ğŸš€ å¿«é€Ÿå¼€å§‹
**ä¿®æ”¹**:
- æ­¥éª¤ 3: åŸ"è¿è¡Œç¬¬ä¸€ä¸ªç¤ºä¾‹"æ”¹ä¸ºæ­¥éª¤ 3
- **æ–°æ­¥éª¤ 4**: "å†…å­˜ä¼˜åŒ–ï¼šåªåŠ è½½ç‰¹å¾ï¼Œè·³è¿‡åŸå§‹æ³¢å½¢"
  - ä»£ç ç¤ºä¾‹
  - æƒè¡¡è¡¨æ ¼
- æ­¥éª¤ 5-6: å‘½ä»¤è¡Œå·¥å…·å’Œç¤ºä¾‹è„šæœ¬ï¼ˆé‡æ–°ç¼–å·ï¼‰

#### `README.md` ğŸ“„ é¡¹ç›®é¦–é¡µ
**ä¿®æ”¹**:
- **åŠŸèƒ½ç‰¹æ€§**:
  - æ·»åŠ æ–°ç‰¹æ€§ï¼š`ğŸ’¡ **å†…å­˜ä¼˜åŒ–**: å¯é€‰è·³è¿‡æ³¢å½¢åŠ è½½ä»¥èŠ‚çœ 70-80% å†…å­˜`

- **å¿«é€Ÿå¼€å§‹**:
  - æ·»åŠ æ–°å­ç« èŠ‚ï¼š"å†…å­˜ä¼˜åŒ–ï¼šè·³è¿‡æ³¢å½¢åŠ è½½"
  - ä»£ç ç¤ºä¾‹
  - å‚è€ƒé“¾æ¥åˆ°å®Œæ•´æŒ‡å—

---

## å˜æ›´ç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| ä¿®æ”¹çš„ Python æ–‡ä»¶ | 1 | `dataset.py` çš„ 4 ä¸ªæ–¹æ³•ä¿®æ”¹ |
| æ–°å¢ Python æ–‡ä»¶ | 3 | skip_waveforms.py, demo_skip_waveforms.py, test_skip_waveforms.py |
| æ–°å¢æ–‡æ¡£ | 2 | MEMORY_OPTIMIZATION.md, HOW_TO_SKIP_WAVEFORMS.md |
| ä¿®æ”¹æ–‡æ¡£ | 3 | README.md, QUICKSTART.md, docs/USAGE.md |
| **æ€»è®¡** | **9** | å®Œå…¨é›†æˆçš„åŠŸèƒ½ |

---

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```python
from waveform_analysis import WaveformDataset

# èŠ‚çœå†…å­˜çš„æ–¹å¼
dataset = WaveformDataset(
    char="50V_OV_circulation_20thr",
    load_waveforms=False  # å…³é”®å‚æ•°
)

(dataset
    .load_raw_data()
    .extract_waveforms()      # è¢«è·³è¿‡
    .build_waveform_features()  # ä»ä¼šè¿è¡Œ
    .build_dataframe()
    .pair_events())

# ç»“æœå®Œå…¨ç›¸åŒ
df = dataset.get_paired_events()
print(f"äº‹ä»¶æ•°: {len(df)}")
print(f"å¹³å‡å³°å€¼: {df['peak_ch6'].mean():.1f} ADC")
```

### æ€§èƒ½å¯¹æ¯”

```
ä¸åŠ è½½æ³¢å½¢:
  å†…å­˜: ~100 MB
  æ—¶é—´: ~3 ç§’
  
åŠ è½½æ³¢å½¢:
  å†…å­˜: ~500 MB
  æ—¶é—´: ~30 ç§’

èŠ‚çœ: 80% å†…å­˜, 10x æ›´å¿«
```

---

## åå‘å…¼å®¹æ€§

âœ… **å®Œå…¨åå‘å…¼å®¹**

- `load_waveforms` å‚æ•°é»˜è®¤ä¸º `True`
- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- é»˜è®¤è¡Œä¸ºä¸ä¹‹å‰å®Œå…¨ç›¸åŒ

```python
# æ—§ä»£ç å®Œå…¨æœ‰æ•ˆ
dataset = WaveformDataset(char="50V_OV_circulation_20thr")
# ç­‰åŒäº load_waveforms=Trueï¼ˆé»˜è®¤ï¼‰
```

---

## å®ç°ç»†èŠ‚

### ä»£ç å˜æ›´ä½ç½®

**dataset.py ä¸­çš„å…³é”®å˜æ›´**:

```python
# 1. __init__ æ–¹æ³•
def __init__(self, ..., load_waveforms: bool = True):
    self.load_waveforms = load_waveforms

# 2. extract_waveforms æ–¹æ³•
def extract_waveforms(self):
    if not self.load_waveforms:
        print("è·³è¿‡æ³¢å½¢æå–ï¼ˆload_waveforms=Falseï¼‰")
        return self
    # ... åŸæœ‰ä»£ç  ...

# 3. structure_waveforms æ–¹æ³•
def structure_waveforms(self):
    if not self.load_waveforms:
        print("è·³è¿‡æ³¢å½¢ç»“æ„åŒ–ï¼ˆload_waveforms=Falseï¼‰")
        return self
    # ... åŸæœ‰ä»£ç  ...

# 4. get_waveform_at æ–¹æ³•
def get_waveform_at(self, event_idx, channel):
    if not self.load_waveforms:
        print("âš ï¸  æ³¢å½¢æ•°æ®æœªåŠ è½½ï¼ˆload_waveforms=Falseï¼‰")
        return None
    # ... åŸæœ‰ä»£ç  ...
```

---

## éªŒè¯æ–¹å¼

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡ŒåŠŸèƒ½æµ‹è¯•
python tests/test_skip_waveforms.py

# è¿è¡Œæ¼”ç¤ºè„šæœ¬
python scripts/demo_skip_waveforms.py

# è¿è¡Œå®Œæ•´ç¤ºä¾‹
python examples/skip_waveforms.py
```

### éªŒè¯å®‰è£…

```python
from waveform_analysis import WaveformDataset

# éªŒè¯å‚æ•°å¯ç”¨
ds = WaveformDataset(char="test", load_waveforms=False)
print(f"load_waveforms: {ds.load_waveforms}")  # False
```

---

## æ–‡æ¡£ç»“æ„

```
é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ HOW_TO_SKIP_WAVEFORMS.md          â† å¿«é€Ÿå‚è€ƒæŒ‡å— ğŸ¯
â”œâ”€â”€ README.md                          â† æ›´æ–°äº†å†…å­˜ä¼˜åŒ–
â”œâ”€â”€ QUICKSTART.md                      â† æ·»åŠ æ­¥éª¤ 4
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ MEMORY_OPTIMIZATION.md         â† å®Œæ•´æŒ‡å— ğŸ“–
â”‚   â”œâ”€â”€ USAGE.md                       â† æ·»åŠ å†…å­˜ä¼˜åŒ–ç« èŠ‚
â”‚   â””â”€â”€ ...
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ skip_waveforms.py              â† å®Œæ•´ç¤ºä¾‹ ğŸ’»
â”‚   â””â”€â”€ ...
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ demo_skip_waveforms.py         â† æ¼”ç¤ºè„šæœ¬ ğŸ“Š
â”‚   â””â”€â”€ ...
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_skip_waveforms.py         â† æµ‹è¯•ç”¨ä¾‹ ğŸ§ª
â”‚   â””â”€â”€ ...
â””â”€â”€ waveform_analysis/
    â””â”€â”€ core/
        â””â”€â”€ dataset.py                 â† æ ¸å¿ƒå®ç°
```

---

## åç»­å·¥ä½œï¼ˆå¯é€‰ï¼‰

- [ ] æ·»åŠ æ›´å¤šæ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] åˆ›å»ºæ€§èƒ½ç›‘æ§è„šæœ¬
- [ ] æ·»åŠ  CI/CD é›†æˆæµ‹è¯•
- [ ] ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
- [ ] æ‰©å±•åˆ°å…¶ä»–åŠ è½½é€‰é¡¹ï¼ˆå¦‚ `load_peaks_only` ç­‰ï¼‰

---

## æ€»ç»“

âœ… **åŠŸèƒ½å®Œæ•´**
- æ ¸å¿ƒå®ç°ï¼š4 ä¸ªæ–¹æ³•ä¿®æ”¹
- æ–‡æ¡£è¦†ç›–ï¼š2 ä»½å®Œæ•´æŒ‡å—
- ç¤ºä¾‹ä»£ç ï¼š3 ä»½ç¤ºä¾‹
- æµ‹è¯•ç”¨ä¾‹ï¼šå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•

âœ… **æ˜“äºä½¿ç”¨**
- ä¸€ä¸ªå¸ƒå°”å‚æ•°
- æ¸…æ™°çš„æ–‡æ¡£
- å¤šä¸ªç¤ºä¾‹
- å®Œæ•´çš„è¯´æ˜

âœ… **å……åˆ†è®°å½•**
- ä»£ç æ³¨é‡Š
- å¤šä»½æŒ‡å—
- ç¤ºä¾‹å’Œæ¼”ç¤º
- å¿«é€Ÿå‚è€ƒ

âœ… **å®Œå…¨å…¼å®¹**
- é»˜è®¤è¡Œä¸ºä¸å˜
- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- æ–°åŠŸèƒ½å¯é€‰

**ç”¨æˆ·ç°åœ¨å¯ä»¥è½»æ¾é€‰æ‹©æ˜¯å¦åŠ è½½æ³¢å½¢ï¼Œæ»¡è¶³ä¸åŒçš„æ€§èƒ½å’Œå†…å­˜éœ€æ±‚ï¼**
